# 🔧 环境变量配置指南

## 📋 快速开始

### 第 1 步：创建 `.env.local` 文件

在项目根目录创建 `.env.local` 文件：

```bash
cd /Users/songhaonan/myFile/玉石网站/jade-gems
touch .env.local
```

### 第 2 步：复制以下内容到 `.env.local`

```bash
# ===================================
# 数据库配置（必需）
# ===================================
DATABASE_URL="postgresql://user:password@host:port/database?pgbouncer=true"
DIRECT_URL="postgresql://user:password@host:port/database"

# ===================================
# Stripe 支付配置（必需）
# ===================================
STRIPE_SECRET_KEY="sk_test_替换为你的stripe密钥"
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="pk_test_替换为你的stripe公钥"
STRIPE_WEBHOOK_SECRET="whsec_替换为你的webhook密钥"

# ===================================
# 网站配置（必需）
# ===================================
NEXT_PUBLIC_SITE_URL="http://localhost:3000"

# ===================================
# 管理员配置（必需）
# ===================================
ADMIN_EMAILS="song@demo.com"
```

### 第 3 步：填写实际配置值

#### 1️⃣ 数据库配置

从您的 Supabase 或 PostgreSQL 服务获取：

```bash
# 示例（替换为实际值）
DATABASE_URL="postgresql://postgres.xxx:password@aws-0-us-east-1.pooler.supabase.com:6543/postgres?pgbouncer=true"
DIRECT_URL="postgresql://postgres.xxx:password@aws-0-us-east-1.pooler.supabase.com:5432/postgres"
```

#### 2️⃣ Stripe 配置（获取方法见下方）

```bash
# 从 Stripe Dashboard 获取
STRIPE_SECRET_KEY="sk_test_51xxxxx"
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="pk_test_51xxxxx"
```

#### 3️⃣ 网站 URL

```bash
# 本地开发
NEXT_PUBLIC_SITE_URL="http://localhost:3000"

# 生产环境（部署后替换）
# NEXT_PUBLIC_SITE_URL="https://linxijade.songhaonan.site"
```

### 第 4 步：重启开发服务器

```bash
# 停止当前服务器（Ctrl+C）
# 重新启动
npm run dev
```

---

## 🔑 如何获取 Stripe 密钥

### 方法一：使用测试密钥（推荐本地开发）

1. 访问 [Stripe Dashboard](https://dashboard.stripe.com/)
2. 确保左上角显示 **Test mode**（测试模式）
3. 点击右上角 **Developers**
4. 点击 **API keys**
5. 复制两个密钥：
   - **Secret key**: `sk_test_xxx`（点击 Reveal test key 显示）
   - **Publishable key**: `pk_test_xxx`

### 方法二：使用生产密钥（生产环境）

1. 完成 Stripe 账户激活
2. 切换到 **Live mode**（生产模式）
3. 按照上述步骤获取 `sk_live_xxx` 和 `pk_live_xxx`

---

## ✅ 配置检查清单

完成配置后，请确认：

- [ ] `.env.local` 文件已创建在项目根目录
- [ ] `DATABASE_URL` 已填写且可连接
- [ ] `STRIPE_SECRET_KEY` 已从 Stripe Dashboard 复制
- [ ] `NEXT_PUBLIC_SITE_URL` 已设置为 `http://localhost:3000`
- [ ] 已重启开发服务器（`npm run dev`）
- [ ] 访问 http://localhost:3000 无报错

---

## 🧪 测试配置是否成功

### 1. 测试数据库连接

```bash
npm run prisma studio
```

如果能打开 Prisma Studio，说明数据库配置正确。

### 2. 测试支付功能

1. 访问 http://localhost:3000
2. 添加商品到购物车
3. 点击 **去结账**
4. 如果跳转到 Stripe Checkout 页面，说明配置成功！

### 3. 查看控制台日志

如果配置有误，控制台会显示：

```
[Checkout API] 缺少必要的环境变量:
- STRIPE_SECRET_KEY: ❌ 未配置
- NEXT_PUBLIC_SITE_URL: ❌ 未配置
请参考文档: docs/Stripe支付配置指南.md
```

---

## 🚨 常见问题

### Q1: 修改 `.env.local` 后不生效？

**A**: 必须重启开发服务器：

```bash
# 停止当前服务器（Ctrl+C 或 Cmd+C）
npm run dev
```

### Q2: `.env.local` 文件放在哪里？

**A**: 项目根目录，与 `package.json` 同级：

```
jade-gems/
├── .env.local          ← 这里
├── package.json
├── src/
└── ...
```

### Q3: 可以使用 `.env` 代替 `.env.local` 吗？

**A**: 不推荐。`.env.local` 优先级更高，且通常被 `.gitignore` 忽略，更安全。

### Q4: 生产环境如何配置？

**A**: 在 Vercel 项目设置中添加环境变量：

1. 打开 Vercel 项目
2. Settings → Environment Variables
3. 添加所有变量（使用生产环境的值）
4. 重新部署

### Q5: Stripe 测试密钥可以在生产环境使用吗？

**A**: 不可以！测试密钥（`sk_test_`）只能本地开发使用，生产环境必须使用生产密钥（`sk_live_`）。

---

## 📚 相关文档

- [Stripe 支付配置指南](./Stripe支付配置指南.md) - Stripe 详细配置
- [Next.js 环境变量文档](https://nextjs.org/docs/basic-features/environment-variables)
- [Vercel 环境变量文档](https://vercel.com/docs/environment-variables)

---

**配置完成后，您就可以开始测试支付功能了！** 🎉

