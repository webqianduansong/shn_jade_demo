# 生产环境数据库同步指南

本指南用于将新的数据库表（如 Banner 表）同步到生产环境。

## 🎯 问题说明

当你在本地添加了新的数据库表（如 Banner），但生产环境数据库还没有这个表时，会出现以下错误：

```
{"success":false,"error":"获取轮播图失败"}
```

或者 Prisma 错误：
```
P2021: The table does not exist in the current database
```

## ✅ 解决方案

### 方法 1：本地执行（推荐）

在本地使用生产环境的数据库连接执行同步：

```bash
# 1. 获取生产环境的数据库连接字符串
# 从 Vercel 环境变量中复制 DATABASE_URL 和 DIRECT_URL

# 2. 在本地执行同步
DATABASE_URL="你的DATABASE_URL" \
DIRECT_URL="你的DIRECT_URL" \
npx prisma db push
```

**完整示例：**

```bash
# Supabase 连接示例
DATABASE_URL="postgresql://postgres.xxx:password@aws-1-ap-southeast-1.pooler.supabase.com:6543/postgres?pgbouncer=true" \
DIRECT_URL="postgresql://postgres.xxx:password@aws-1-ap-southeast-1.pooler.supabase.com:5432/postgres" \
npx prisma db push
```

### 方法 2：使用便捷脚本

```bash
# 给脚本添加执行权限
chmod +x scripts/sync-production-db.sh

# 运行脚本
DATABASE_URL="你的DATABASE_URL" \
DIRECT_URL="你的DIRECT_URL" \
./scripts/sync-production-db.sh
```

### 方法 3：Vercel CLI（高级）

如果你安装了 Vercel CLI：

```bash
# 1. 链接到你的 Vercel 项目
vercel link

# 2. 拉取环境变量
vercel env pull .env.production

# 3. 使用生产环境变量同步
source .env.production
npx prisma db push
```

## 📋 详细步骤

### 步骤 1：获取数据库连接字符串

1. 登录 [Vercel Dashboard](https://vercel.com/dashboard)
2. 选择你的项目
3. 进入 **Settings** → **Environment Variables**
4. 复制以下变量的值：
   - `DATABASE_URL`
   - `DIRECT_URL`

### 步骤 2：本地同步数据库

打开终端，执行：

```bash
cd /path/to/jade-gems

# 替换下面的连接字符串为你自己的
DATABASE_URL="postgresql://..." \
DIRECT_URL="postgresql://..." \
npx prisma db push
```

### 步骤 3：验证同步

同步成功后，你会看到：

```
✔ Generated Prisma Client
🚀 Your database is now in sync with your Prisma schema.
```

### 步骤 4：触发 Vercel 重新部署

```bash
# 推送代码触发部署
git add .
git commit -m "docs: 添加数据库同步文档"
git push origin main
```

或者在 Vercel Dashboard 手动触发重新部署。

## 🔍 验证数据库同步

### 检查数据库

使用数据库客户端（如 TablePlus、DBeaver）连接到生产数据库，确认 `Banner` 表已创建。

**表结构应该包含：**

| 字段 | 类型 | 说明 |
|------|------|------|
| id | String | 主键 |
| title | String | 标题 |
| description | String? | 描述 |
| imageUrl | String | 图片URL |
| linkUrl | String? | 跳转地址 |
| sortOrder | Int | 排序 |
| isActive | Boolean | 是否启用 |
| createdAt | DateTime | 创建时间 |
| updatedAt | DateTime | 更新时间 |

### 检查 API

访问生产环境 API：

```bash
# 检查公开接口
curl https://your-domain.com/api/banners

# 应该返回
{"success":true,"banners":[]}
```

### 检查首页

访问网站首页：

```
https://your-domain.com
```

- ✅ 页面应该正常加载
- ✅ 不再显示 "暂无轮播图" 提示
- ✅ 如果有轮播图数据，应该正常显示

## 📝 添加轮播图数据

数据库同步成功后：

1. 访问管理系统
   ```
   https://your-domain.com/zh/admin/login
   ```

2. 登录管理员账号

3. 进入 **轮播图管理**

4. 点击 **新增轮播图**

5. 填写信息：
   - 上传图片（建议尺寸：1920x600）
   - 填写标题
   - 填写描述（可选）
   - 填写跳转地址（可选）
   - 设置排序（0最前）
   - 启用状态

6. 保存

7. 刷新首页查看效果

## 🚨 常见问题

### Q: 执行 `prisma db push` 时报错 "Can't reach database server"

**A:** 检查数据库连接字符串是否正确：

```bash
# 测试连接
psql "你的DIRECT_URL"
```

### Q: 提示 "Environment variable not found: DIRECT_URL"

**A:** 确保在命令前设置了环境变量：

```bash
# ❌ 错误
npx prisma db push

# ✅ 正确
DATABASE_URL="..." DIRECT_URL="..." npx prisma db push
```

### Q: 同步后首页还是显示错误

**A:** 
1. 清除浏览器缓存
2. 在 Vercel 手动触发重新部署
3. 检查 Vercel 的部署日志

### Q: Banner 表已存在，但接口还是报错

**A:** 检查 Prisma Client 是否已更新：

```bash
# 重新生成 Prisma Client
npx prisma generate

# 重新部署
git push origin main
```

## ⚠️ 注意事项

1. **备份数据**：执行 `prisma db push` 前建议备份数据库
2. **环境区分**：确保使用正确的数据库连接（生产环境）
3. **权限确认**：确保数据库用户有创建表的权限
4. **避免冲突**：不要在有用户访问时进行数据库迁移

## 🎉 成功标志

同步成功后：

- ✅ 首页正常加载，无错误提示
- ✅ 管理系统可以添加轮播图
- ✅ 添加的轮播图在首页正常显示
- ✅ 控制台没有数据库相关错误

## 📞 需要帮助？

如果遇到问题：

1. 检查 Vercel 部署日志
2. 检查浏览器控制台错误
3. 检查数据库连接是否正常
4. 查看 Prisma 文档：https://www.prisma.io/docs

---

**最后更新：** 2025-10-30  
**相关文档：** 
- [部署支付功能到生产环境.md](./部署支付功能到生产环境.md)
- [环境变量配置.md](./环境变量配置.md)

