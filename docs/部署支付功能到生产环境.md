# 🚀 部署支付功能到生产环境

## 📋 部署清单

- [ ] 数据库迁移（创建订单、地址等表）
- [ ] Vercel 环境变量配置
- [ ] Stripe 生产环境密钥配置
- [ ] 测试支付流程

---

## 1️⃣ 数据库迁移（必需）

### 为什么需要迁移？

新增加的功能需要以下数据库表：
- ✅ `Order` - 订单表
- ✅ `OrderItem` - 订单商品项
- ✅ `Address` - 用户收货地址
- ✅ `ShippingTracking` - 物流追踪

### 方法一：使用 Prisma Migrate（推荐）

```bash
# 1. 确保 .env.local 配置正确
# DATABASE_URL 和 DIRECT_URL 必须正确

# 2. 生成新的迁移文件
npx prisma migrate dev --name add_order_and_address_tables

# 3. 应用迁移到数据库
npx prisma migrate deploy
```

**注意**：如果提示迁移冲突，使用方法二。

---

### 方法二：使用 db push（快速）

如果迁移历史有问题，直接同步 schema：

```bash
# 直接将 schema 推送到数据库（会覆盖现有表结构）
npx prisma db push

# 如果需要强制推送（删除旧数据）
npx prisma db push --accept-data-loss
```

**警告**：`--accept-data-loss` 会删除不兼容的数据，请谨慎使用！

---

### 验证迁移成功

```bash
# 打开 Prisma Studio 查看数据库
npx prisma studio

# 访问 http://localhost:5555
# 检查是否有以下表：
# - Order
# - OrderItem
# - Address
# - ShippingTracking
```

---

## 2️⃣ Vercel 环境变量配置（必需）

### 需要在 Vercel 添加的环境变量：

登录 Vercel → 选择项目 → Settings → Environment Variables

#### A. 数据库配置（已有）

```bash
DATABASE_URL="你的数据库连接URL"
DIRECT_URL="你的数据库直连URL"
```

#### B. Stripe 配置（新增）

```bash
# Stripe Secret Key（生产环境）
STRIPE_SECRET_KEY="sk_live_你的生产环境密钥"

# Stripe Publishable Key（生产环境，可选）
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="pk_live_你的生产环境公钥"

# Stripe Webhook Secret（配置 Webhook 后添加）
STRIPE_WEBHOOK_SECRET="whsec_你的webhook密钥"
```

⚠️ **重要**：
- **测试环境**用 `sk_test_xxx`
- **生产环境**用 `sk_live_xxx`
- 不要混用！

#### C. 网站 URL 配置（必需）

```bash
# 网站完整 URL（用于支付回调）
NEXT_PUBLIC_SITE_URL="https://linxijade.songhaonan.site"
```

#### D. 管理员配置（已有）

```bash
ADMIN_EMAILS="song@demo.com"
```

---

### 在 Vercel 添加环境变量的步骤：

1. **访问项目设置**
   ```
   https://vercel.com/你的用户名/你的项目名/settings/environment-variables
   ```

2. **添加变量**
   - 点击 "Add" 按钮
   - Name: `STRIPE_SECRET_KEY`
   - Value: `sk_live_你的密钥`
   - Environment: 选择 `Production`（生产环境）
   - 点击 "Save"

3. **重复以上步骤**添加所有必需的环境变量

4. **重新部署**
   - 添加完环境变量后
   - 点击 "Deployments" 标签
   - 点击最新部署旁的 "..." 按钮
   - 选择 "Redeploy"

---

## 3️⃣ Stripe 生产环境配置

### A. 激活 Stripe 账户

1. **登录 Stripe Dashboard**
   ```
   https://dashboard.stripe.com/
   ```

2. **完成账户激活**
   - 点击右上角 "Activate your account"
   - 填写企业/个人信息
   - 提供银行账户信息
   - 上传身份验证文件

### B. 获取生产环境密钥

1. **切换到生产模式**
   - 在 Stripe Dashboard 右上角
   - 关闭 "Test mode"（测试模式）开关

2. **获取 API 密钥**
   - 访问: Developers → API keys
   - 复制两个密钥：
     - `sk_live_xxx` - Secret key
     - `pk_live_xxx` - Publishable key

3. **启用支付方式**
   - Settings → Payment methods
   - 启用：
     - ✅ Card（信用卡）
     - ✅ Alipay（支付宝）
     - ✅ WeChat Pay（微信支付）

### C. 配置 Webhook（可选但推荐）

Webhook 用于接收支付成功的回调，自动更新订单状态。

1. **添加 Webhook 端点**
   ```
   Stripe Dashboard → Developers → Webhooks → Add endpoint
   ```

2. **配置端点 URL**
   ```
   https://linxijade.songhaonan.site/api/stripe/webhook
   ```

3. **选择事件**
   - `checkout.session.completed` - 结账完成
   - `payment_intent.succeeded` - 支付成功
   - `payment_intent.payment_failed` - 支付失败

4. **复制 Signing Secret**
   - 显示为 `whsec_xxx`
   - 添加到 Vercel 环境变量：`STRIPE_WEBHOOK_SECRET`

⚠️ **注意**：目前项目中还没有 `/api/stripe/webhook` 端点，这是下一步的优化项。

---

## 4️⃣ 环境变量完整清单

### 本地开发 (.env.local)

```bash
# 数据库
DATABASE_URL="postgresql://..."
DIRECT_URL="postgresql://..."

# Stripe（测试环境）
STRIPE_SECRET_KEY="sk_test_..."
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="pk_test_..."

# 网站 URL
NEXT_PUBLIC_SITE_URL="http://localhost:3000"

# 管理员
ADMIN_EMAILS="song@demo.com"
```

### 生产环境 (Vercel)

```bash
# 数据库（与本地相同）
DATABASE_URL="postgresql://..."
DIRECT_URL="postgresql://..."

# Stripe（生产环境）⚠️ 不同！
STRIPE_SECRET_KEY="sk_live_..."
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="pk_live_..."
STRIPE_WEBHOOK_SECRET="whsec_..."

# 网站 URL ⚠️ 不同！
NEXT_PUBLIC_SITE_URL="https://linxijade.songhaonan.site"

# 管理员（与本地相同）
ADMIN_EMAILS="song@demo.com"
```

---

## 5️⃣ 部署步骤（完整流程）

### 步骤 1：本地数据库迁移

```bash
# 1. 确保本地配置正确
cat .env.local

# 2. 执行迁移
npx prisma db push

# 3. 验证迁移
npx prisma studio
# 检查是否有 Order, OrderItem, Address 表
```

### 步骤 2：推送代码到 GitHub

```bash
# 确保所有更改已提交
git status

# 如果有未提交的更改
git add -A
git commit -m "feat: 完成支付功能"
git push origin main
```

### 步骤 3：配置 Vercel 环境变量

访问：https://vercel.com/你的项目/settings/environment-variables

添加以下变量（生产环境）：
```
STRIPE_SECRET_KEY=sk_live_...
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_live_...
NEXT_PUBLIC_SITE_URL=https://linxijade.songhaonan.site
```

### 步骤 4：重新部署 Vercel

方法一（自动）：
- Vercel 会自动检测 GitHub 推送
- 等待部署完成

方法二（手动）：
```bash
# 访问 Vercel Dashboard
https://vercel.com/你的项目/deployments

# 点击最新部署的 "..." 按钮
# 选择 "Redeploy"
```

### 步骤 5：生产环境数据库迁移

```bash
# 方法一：在 Vercel 中运行（推荐）
# 1. 访问项目设置
# 2. Settings → Functions
# 3. 在构建命令中添加：
#    npx prisma generate && npx prisma db push

# 方法二：本地运行（使用生产数据库）
# 1. 临时修改 .env.local 为生产数据库
# 2. 运行: npx prisma db push
# 3. 改回本地数据库配置
```

⚠️ **推荐方法**：
```bash
# 直接在本地连接生产数据库执行迁移
DATABASE_URL="生产数据库URL" npx prisma db push
```

### 步骤 6：测试生产环境

访问：https://linxijade.songhaonan.site

测试流程：
1. ✅ 登录账户
2. ✅ 添加商品到购物车
3. ✅ 点击"去结账"
4. ✅ 跳转到 Stripe Checkout
5. ✅ 使用测试卡号支付（生产环境也可以用测试卡）
6. ✅ 支付成功页面显示
7. ✅ 个人中心查看订单

---

## 6️⃣ 常见问题排查

### Q1: 数据库迁移失败？

**错误信息**：
```
P3006: Migration failed to apply cleanly
```

**解决方案**：
```bash
# 使用 db push 强制同步
npx prisma db push --accept-data-loss
```

---

### Q2: Vercel 部署后支付报错？

**错误信息**：
```
Missing STRIPE_SECRET_KEY or NEXT_PUBLIC_SITE_URL
```

**解决方案**：
1. 检查 Vercel 环境变量是否添加
2. 确保选择了 "Production" 环境
3. 重新部署项目

---

### Q3: 支付成功但订单状态还是 PENDING？

**原因**：
- 这是正常的！
- 订单初始状态为 PENDING（待支付）
- 需要配置 Webhook 才能自动更新为 PAID

**临时解决方案**：
- 手动在数据库中更新订单状态
- 或在 Stripe Dashboard 查看支付记录

**长期解决方案**：
- 实现 `/api/stripe/webhook` 端点
- 配置 Webhook（见上文）

---

### Q4: 如何查看生产环境的数据库？

**方法一：Prisma Studio**
```bash
# 连接到生产数据库
DATABASE_URL="生产数据库URL" npx prisma studio
```

**方法二：Supabase Dashboard**
```
访问: https://supabase.com/dashboard
选择项目 → Table Editor
```

---

## 7️⃣ 安全检查清单

部署前请确认：

- [ ] **Stripe 密钥**
  - [ ] 生产环境使用 `sk_live_` 开头的密钥
  - [ ] 测试环境使用 `sk_test_` 开头的密钥
  - [ ] 密钥没有提交到 Git

- [ ] **数据库**
  - [ ] 生产数据库有备份
  - [ ] 迁移已测试
  - [ ] 数据库连接安全（使用 SSL）

- [ ] **环境变量**
  - [ ] 所有必需变量已添加到 Vercel
  - [ ] `NEXT_PUBLIC_SITE_URL` 使用正确的域名
  - [ ] 没有泄露敏感信息

- [ ] **功能测试**
  - [ ] 本地测试通过
  - [ ] 生产环境支付流程正常
  - [ ] 订单创建成功
  - [ ] 个人中心显示正常

---

## 8️⃣ 部署后监控

### 监控项目：

1. **Stripe Dashboard**
   ```
   https://dashboard.stripe.com/payments
   ```
   - 查看所有支付记录
   - 监控失败的支付

2. **Vercel 日志**
   ```
   https://vercel.com/你的项目/logs
   ```
   - 查看 API 错误
   - 监控性能问题

3. **数据库监控**
   ```
   Supabase Dashboard → Database → Logs
   ```
   - 查看数据库查询
   - 监控慢查询

---

## 9️⃣ 回滚计划

如果生产环境出现问题：

### 快速回滚：

```bash
# 1. 在 Vercel 回滚到上一个版本
Deployments → 选择上一个稳定版本 → Promote to Production

# 2. 或者回滚 Git 提交
git revert HEAD
git push origin main
```

### 数据库回滚：

```bash
# 如果需要回滚数据库（谨慎！）
# 1. 恢复数据库备份
# 2. 或删除新表
DROP TABLE "ShippingTracking";
DROP TABLE "OrderItem";
DROP TABLE "Order";
DROP TABLE "Address";
```

---

## 📚 相关文档

- [Stripe 支付配置指南](./Stripe支付配置指南.md)
- [环境变量配置](./环境变量配置.md)
- [支付功能完整总结](./支付功能完整总结.md)

---

## 🆘 需要帮助？

如果遇到问题：

1. **检查日志**
   - Vercel Logs
   - 浏览器 Console
   - Stripe Dashboard

2. **常见错误排查**
   - 环境变量是否正确
   - 数据库是否迁移
   - API 是否返回正确的数据

3. **联系我**
   - 提供错误信息
   - 提供复现步骤

---

**祝部署顺利！** 🚀

