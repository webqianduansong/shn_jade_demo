# 临熙玉石 - 订单流程设计文档

## 1. 整体流程概览

```
用户浏览商品 → 加入购物车 → 结算 → 选择/填写收货地址 → 选择支付方式 
→ 确认订单 → 支付 → 订单生成 → 商家发货 → 物流追踪 → 确认收货 → 完成
```

---

## 2. 收货地址管理

### 2.1 地址数据结构

```typescript
interface Address {
  id: number;
  userId: number;
  isDefault: boolean;         // 是否默认地址
  
  // 收件人信息
  fullName: string;           // 收件人姓名
  phone: string;              // 手机号码
  email?: string;             // 邮箱（可选）
  
  // 地址信息
  country: string;            // 国家
  state: string;              // 省/州
  city: string;               // 城市
  district?: string;          // 区/县（可选）
  addressLine1: string;       // 详细地址行1（街道、门牌号）
  addressLine2?: string;      // 详细地址行2（公寓、单元等，可选）
  postalCode: string;         // 邮政编码
  
  // 时间戳
  createdAt: Date;
  updatedAt: Date;
}
```

### 2.2 地址管理功能

**个人中心 - 收货地址**
- 地址列表展示（默认地址突出显示）
- 添加新地址
- 编辑地址
- 删除地址
- 设置默认地址
- 地址数量限制：最多 10 个

**地址表单字段**（参考 jademine.com）
1. 收件人姓名（必填）
2. 手机号码（必填，支持国际格式）
3. 邮箱（选填）
4. 国家/地区（下拉选择，必填）
5. 省/州（下拉选择，必填）
6. 城市（输入框，必填）
7. 区/县（输入框，选填）
8. 详细地址（街道、门牌号，必填）
9. 公寓/单元号（选填）
10. 邮政编码（必填）
11. 设为默认地址（复选框）

---

## 3. 结账流程

### 3.1 流程步骤

**步骤 1：购物车页面**
- 展示商品列表
- 修改数量
- 删除商品
- 显示小计
- "去结算" 按钮

**步骤 2：结算页面（Checkout）**

分为 3 个区域：

**左侧区域：订单信息**
```
┌─────────────────────────┐
│ 1. 收货地址              │
│   ○ 选择已有地址         │
│   ○ 添加新地址           │
├─────────────────────────┤
│ 2. 配送方式              │
│   ○ 标准配送（7-15天）   │
│   ○ 快速配送（3-7天）    │
│   ○ 国际快递（5-10天）   │
├─────────────────────────┤
│ 3. 支付方式              │
│   ○ 支付宝               │
│   ○ 微信支付             │
│   ○ 信用卡/借记卡        │
│   ○ PayPal               │
├─────────────────────────┤
│ 4. 订单备注（选填）      │
│   [文本框]               │
└─────────────────────────┘
```

**右侧区域：订单摘要**
```
┌─────────────────────────┐
│ 订单摘要                 │
├─────────────────────────┤
│ 商品（2件）              │
│ - 翡翠戒指 x1  ¥1,299   │
│ - 和田玉挂件 x1 ¥899    │
├─────────────────────────┤
│ 商品小计：¥2,198        │
│ 运费：¥30               │
│ 优惠：-¥100             │
├─────────────────────────┤
│ 总计：¥2,128            │
├─────────────────────────┤
│ [提交订单] 按钮         │
└─────────────────────────┘
```

**步骤 3：支付页面**
- 展示订单号
- 展示支付金额
- 支付二维码/跳转支付平台
- 支付倒计时（15分钟）

**步骤 4：支付成功**
- 订单成功提示
- 订单号
- 查看订单详情按钮
- 继续购物按钮

---

## 4. 订单管理

### 4.1 订单数据结构

```typescript
interface Order {
  id: number;
  orderNo: string;            // 订单号（唯一）
  userId: number;
  
  // 订单状态
  status: 'pending' | 'paid' | 'shipped' | 'delivered' | 'cancelled';
  
  // 收货地址（快照，不关联 Address 表）
  shippingAddress: {
    fullName: string;
    phone: string;
    country: string;
    state: string;
    city: string;
    district?: string;
    addressLine1: string;
    addressLine2?: string;
    postalCode: string;
  };
  
  // 订单商品
  items: OrderItem[];
  
  // 金额信息
  subtotalCents: number;      // 商品小计（分）
  shippingCents: number;      // 运费（分）
  discountCents: number;      // 优惠金额（分）
  totalCents: number;         // 订单总额（分）
  
  // 配送信息
  shippingMethod: string;     // 配送方式
  shippingStatus?: string;    // 物流状态
  trackingNumber?: string;    // 物流单号
  shippingCompany?: string;   // 物流公司
  shippedAt?: Date;           // 发货时间
  deliveredAt?: Date;         // 签收时间
  
  // 支付信息
  paymentMethod: string;      // 支付方式
  paidAt?: Date;              // 支付时间
  
  // 备注
  remark?: string;            // 用户备注
  
  // 时间戳
  createdAt: Date;
  updatedAt: Date;
}

interface OrderItem {
  productId: number;
  productName: string;
  productImage: string;
  quantity: number;
  priceCents: number;         // 购买时单价（分）
  subtotalCents: number;      // 小计（分）
}
```

### 4.2 订单状态流转

```
pending (待支付) 
  ↓ 用户支付成功
paid (已支付) 
  ↓ 商家发货
shipped (已发货) 
  ↓ 用户签收
delivered (已完成)

任何状态都可以：
  → cancelled (已取消)
```

### 4.3 我的订单页面

**订单列表**
- 标签页：全部订单 / 待支付 / 待发货 / 待收货 / 已完成 / 已取消
- 每个订单卡片显示：
  - 订单号
  - 下单时间
  - 订单状态
  - 商品缩略图和名称
  - 订单金额
  - 操作按钮（查看详情、取消订单、确认收货、删除订单）

**订单详情页**

分为 4 个区域：

```
┌─────────────────────────────────────┐
│ 订单状态进度条                       │
│ ● 已下单 → ● 已支付 → ○ 已发货 → ○ 已完成
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 物流信息（如果已发货）               │
│ 物流公司：顺丰速运                   │
│ 运单号：SF1234567890                │
│ [查看物流详情] 按钮                  │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 收货信息                             │
│ 收件人：张三                         │
│ 手机号：138****8888                 │
│ 收货地址：北京市朝阳区...            │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 商品信息                             │
│ [商品列表]                           │
│ 商品小计：¥2,198                    │
│ 运费：¥30                           │
│ 优惠：-¥100                         │
│ 实付款：¥2,128                      │
└─────────────────────────────────────┘
```

---

## 5. 物流追踪

### 5.1 物流追踪数据结构

```typescript
interface ShippingTracking {
  id: number;
  orderId: number;
  trackingNumber: string;     // 物流单号
  shippingCompany: string;    // 物流公司
  
  // 物流轨迹
  timeline: TrackingEvent[];
  
  createdAt: Date;
  updatedAt: Date;
}

interface TrackingEvent {
  timestamp: Date;            // 时间
  status: string;             // 状态
  description: string;        // 描述
  location?: string;          // 地点
}
```

### 5.2 物流追踪页面

**展示方式：时间轴**

```
● 2024-01-20 15:30  [已签收]
  您的快递已签收，感谢使用顺丰速运
  
● 2024-01-20 09:15  [派送中]
  快递员正在派送中，请保持电话畅通
  北京市朝阳区
  
● 2024-01-20 06:00  [到达目的地]
  快件已到达北京朝阳分拨中心
  
● 2024-01-19 18:20  [运输中]
  快件已发车
  
● 2024-01-19 14:00  [已揽收]
  顺丰速运已收取快件
  广东省深圳市
```

---

## 6. 配送方式和运费规则

### 6.1 配送方式

| 方式 | 时效 | 适用范围 | 基础运费 |
|------|------|----------|----------|
| 标准配送 | 7-15天 | 全国 | ¥15 |
| 快速配送 | 3-7天 | 全国 | ¥30 |
| 国际快递 | 5-10天 | 全球 | ¥80 起 |

### 6.2 运费计算规则

1. **按订单金额**
   - 订单满 ¥500 免运费（限标准配送）
   - 订单满 ¥1000 免运费（全部配送方式）

2. **按重量**（国际配送）
   - 首重 500g：¥80
   - 续重每 500g：¥30

3. **按地区**
   - 偏远地区加收 ¥20

---

## 7. 技术实现要点

### 7.1 数据库表设计

**新增表：**
1. `Address` - 收货地址表
2. `ShippingTracking` - 物流追踪表

**修改表：**
1. `Order` - 订单表（增加物流相关字段）

### 7.2 API 接口

**地址管理**
- `GET /api/user/addresses` - 获取地址列表
- `POST /api/user/addresses` - 添加地址
- `PUT /api/user/addresses/:id` - 更新地址
- `DELETE /api/user/addresses/:id` - 删除地址
- `PUT /api/user/addresses/:id/default` - 设为默认

**订单管理**
- `POST /api/orders/create` - 创建订单
- `GET /api/orders` - 获取订单列表
- `GET /api/orders/:id` - 获取订单详情
- `PUT /api/orders/:id/cancel` - 取消订单
- `PUT /api/orders/:id/confirm` - 确认收货

**物流追踪**
- `GET /api/orders/:id/tracking` - 获取物流信息

### 7.3 页面路由

```
/[locale]/profile/addresses          - 地址管理
/[locale]/profile/addresses/new      - 添加地址
/[locale]/profile/addresses/[id]     - 编辑地址
/[locale]/checkout                   - 结算页面
/[locale]/orders                     - 我的订单
/[locale]/orders/[id]                - 订单详情
/[locale]/orders/[id]/tracking       - 物流追踪
```

---

## 8. 页面设计风格

**保持与项目现有风格一致：**

1. **配色方案**
   - 主色：翡翠绿 `#2d5a3d`
   - 辅色：淡绿 `#4a8c5f`
   - 背景：渐变白 `linear-gradient(135deg, #ffffff 0%, #f0f7f3 100%)`

2. **组件样式**
   - 卡片：圆角 `12px`，阴影 `0 2px 8px rgba(45, 90, 61, 0.08)`
   - 按钮：主按钮使用翡翠绿，悬停加深
   - 表单：Ant Design 组件为主

3. **布局**
   - 响应式设计
   - 最大宽度：`max-w-7xl`
   - 间距：`py-8 px-6`

---

## 9. 实施优先级

**Phase 1：基础功能（MVP）**
1. ✅ 收货地址管理（增删改查）
2. ✅ 结算页面（选择地址 + 创建订单）
3. ✅ 我的订单列表
4. ✅ 订单详情页

**Phase 2：增强功能**
1. 物流追踪
2. 多种支付方式
3. 运费计算
4. 订单状态流转

**Phase 3：优化功能**
1. 国际地址支持优化
2. 实时物流查询（第三方 API）
3. 订单导出
4. 发票管理

---

## 10. 注意事项

1. **安全性**
   - 订单创建时记录地址快照（不要关联引用）
   - 支付接口要有签名验证
   - 敏感信息（手机号）要脱敏展示

2. **用户体验**
   - 地址表单要有智能验证
   - 邮编根据国家/地区自动验证格式
   - 保存订单前二次确认
   - 物流信息实时推送通知

3. **国际化**
   - 地址字段要支持中英文
   - 国家/地区列表要完整
   - 货币符号根据地区显示

---

**设计完成日期：** 2025-01-20
**设计人员：** AI Assistant

