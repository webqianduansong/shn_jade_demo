generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum OrderStatus {
  PENDING    // 待支付
  PAID       // 已支付
  FAILED     // 支付失败
  SHIPPED    // 已发货
  DELIVERED  // 已送达
  CANCELLED  // 已取消
}

model User {
  id        String    @id @default(cuid())
  email     String    @unique
  password  String
  name      String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  addresses Address[]
  orders    Order[]
  carts     Cart[]
}

model Category {
  id       String    @id @default(cuid())
  name     String
  slug     String    @unique
  image    String?   // 分类封面图片
  products Product[]
}

model Product {
  id          String         @id @default(cuid())
  name        String
  slug        String         @unique
  description String?
  sku         String?        @unique
  model       String?
  rating      Float          @default(0)
  reviewsCount Int           @default(0)
  price       Int            // 金额（分）
  images      ProductImage[]
  categoryId  String?
  category    Category?      @relation(fields: [categoryId], references: [id])
  isHot       Boolean        @default(false)  // 是否热门商品
  isNew       Boolean        @default(false)  // 是否新品
  isFeatured  Boolean        @default(false)  // 是否精选推荐
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  cartItems   CartItem[]
  orderItems  OrderItem[]
}

model ProductImage {
  id        String  @id @default(cuid())
  url       String
  sortOrder Int     @default(0)
  productId String
  product   Product @relation(fields: [productId], references: [id])
}

model Cart {
  id        String     @id @default(cuid())
  userId    String
  user      User       @relation(fields: [userId], references: [id])
  items     CartItem[]
  updatedAt DateTime   @updatedAt
  createdAt DateTime   @default(now())

  @@unique([userId])
}

model CartItem {
  id        String  @id @default(cuid())
  cartId    String
  productId String
  quantity  Int
  cart      Cart    @relation(fields: [cartId], references: [id])
  product   Product @relation(fields: [productId], references: [id])

  @@unique([cartId, productId])
}

model Order {
  id            String       @id @default(cuid())
  orderNo       String       @unique  // 订单号
  userId        String
  user          User         @relation(fields: [userId], references: [id])
  status        OrderStatus  @default(PENDING)
  
  // 收货地址（快照，JSON 格式）
  shippingAddress   Json
  shippingAddressId String?   // 关联的地址 ID（可选）
  
  // 金额信息（单位：分）
  subtotalCents   Int         // 商品小计
  shippingCents   Int         // 运费
  discountCents   Int         @default(0)  // 优惠金额
  totalCents      Int         // 订单总额
  
  // 配送信息
  shippingMethod   String?    // 配送方式
  shippingStatus   String?    // 物流状态
  trackingNumber   String?    // 物流单号
  shippingCompany  String?    // 物流公司
  shippedAt        DateTime?  // 发货时间
  deliveredAt      DateTime?  // 签收时间
  
  // 支付信息
  paymentMethod String?       // 支付方式
  paymentRef    String?       // 支付参考号
  paidAt        DateTime?     // 支付时间
  
  // 备注
  remark        String?       // 用户备注
  
  items         OrderItem[]
  tracking      ShippingTracking[]
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  productId String
  price     Int
  quantity  Int
  order     Order   @relation(fields: [orderId], references: [id])
  product   Product @relation(fields: [productId], references: [id])
}

model Address {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id])
  isDefault    Boolean  @default(false)  // 是否默认地址
  
  // 收件人信息
  fullName     String   // 收件人姓名
  phone        String   // 手机号码
  email        String?  // 邮箱（可选）
  
  // 地址信息
  country      String   // 国家
  state        String   // 省/州
  city         String   // 城市
  district     String?  // 区/县（可选）
  addressLine1 String   // 详细地址行1
  addressLine2 String?  // 详细地址行2（可选）
  postalCode   String   // 邮政编码
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model ShippingTracking {
  id              String   @id @default(cuid())
  orderId         String
  order           Order    @relation(fields: [orderId], references: [id])
  trackingNumber  String   // 物流单号
  shippingCompany String   // 物流公司
  timeline        Json     // 物流轨迹（JSON 数组）
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Banner {
  id          String   @id @default(cuid())
  title       String   // 标题
  description String?  // 描述（可选）
  imageUrl    String   // 图片URL
  linkUrl     String?  // 跳转地址（可选）
  sortOrder   Int      @default(0) // 排序顺序（数字越小越靠前）
  isActive    Boolean  @default(true) // 是否启用
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

